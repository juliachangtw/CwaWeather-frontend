<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>æ£®æ£®å¤©æ°£ | æ°£è±¡ä¾¿æ¢ç‰†</title>
    <link rel="icon" type="image/png" href="./icon-v2.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Mali:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* === æ–‡å…·åº—ç²‰å½©é…è‰² (Pastel Palette) === */
        --paper-yellow: #fff9c4;
        --paper-pink: #ffcdd2;
        --paper-blue: #b3e5fc;
        --paper-green: #c8e6c9;
        --paper-purple: #e1bee7;
        --paper-white: #fafafa;

        /* ç­†è·¡é¡è‰² */
        --ink-primary: #37474f; /* é‰›ç­†æ·±ç° */
        --ink-secondary: #78909c;
        --ink-accent: #ff7043; /* é‡é»ç­†æ©˜è‰² */

        /* èƒŒæ™¯ç‰†é¢è‰² */
        --wall-bg: #f0f4f8;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: "Mali", cursive, sans-serif;
        background-color: var(--wall-bg);
        color: var(--ink-primary);
        min-height: 100vh;
        overflow-x: hidden;
        /* é»ç‹€ç¶²æ ¼èƒŒæ™¯ (Dot Grid) æ¨¡æ“¬æ‰‹å¸³æœ¬æˆ–ç‰†é¢ */
        background-image: radial-gradient(#cfd8dc 1px, transparent 1px);
        background-size: 20px 20px;
        padding-bottom: 40px;
      }

      /* === é ‚éƒ¨å·¥å…·åˆ— (åƒè²¼åœ¨ç‰†ä¸Šçš„æ¨™ç±¤) === */
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        position: sticky;
        top: 0;
        z-index: 100;
        pointer-events: none; /* è®“é»æ“Šç©¿é€ */
      }

      .location-tag {
        pointer-events: auto;
        background: var(--ink-primary);
        color: white;
        padding: 8px 15px;
        font-size: 1.1rem;
        font-weight: 700;
        /* é‹¸é½’ç‹€é‚Šç·£ (CSS Mask) æ¨¡æ“¬æ’•ä¸‹çš„è† å¸¶ */
        clip-path: polygon(0% 0%, 100% 0%, 95% 50%, 100% 100%, 0% 100%, 5% 50%);
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        transform: rotate(-2deg);
      }

      .date-stamp {
        font-family: "Caveat", cursive;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--ink-secondary);
        transform: rotate(2deg);
        text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.8);
      }

      .container {
        padding: 10px 20px;
        max-width: 600px;
        margin: 0 auto;
      }

      /* === é€šç”¨ï¼šä¾¿æ¢ç´™æ•ˆæœ (The Note) === */
      .paper-note {
        position: relative;
        padding: 25px;
        color: var(--ink-primary);
        /* é—œéµï¼šåˆ©ç”¨ border-radius å‰µé€ ä¸è¦å‰‡çš„æœ‰æ©Ÿå½¢ç‹€ï¼Œä¸åƒé›»è…¦ç•«çš„ */
        border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
        /* ç´™å¼µæµ®èµ·ä¾†çš„é™°å½± */
        box-shadow: 2px 5px 15px rgba(0, 0, 0, 0.1),
          0 1px 2px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      /* ç´™è† å¸¶è£é£¾ (Tape) */
      .tape {
        position: absolute;
        top: -10px;
        left: 50%;
        width: 100px;
        height: 30px;
        transform: translateX(-50%) rotate(-1deg);
        background-color: rgba(255, 235, 59, 0.6); /* åŠé€æ˜é»ƒè‰²è† å¸¶ */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        opacity: 0.8;
        z-index: 10;
        /* è† å¸¶å…©é‚Šçš„æ’•è£‚æ„Ÿ */
        mask-image: url("data:image/svg+xml;utf8,<svg width='100' height='30' xmlns='http://www.w3.org/2000/svg'><path d='M0,0 L100,0 L95,15 L100,30 L0,30 L5,15 Z' fill='black'/></svg>");
        -webkit-mask-image: url("data:image/svg+xml;utf8,<svg width='100' height='30' xmlns='http://www.w3.org/2000/svg'><path d='M0,0 L100,0 L95,15 L100,30 L0,30 L5,15 Z' fill='black'/></svg>");
        mask-size: 100% 100%;
      }

      /* === ä¸»ç•«é¢ï¼šä»Šæ—¥å¤§ä¾¿æ¢ === */
      .hero-note {
        background-color: var(--paper-yellow);
        margin-top: 20px;
        margin-bottom: 40px;
        text-align: center;
        transform: rotate(1deg); /* å¾®å¾®æ­ªæ–œ */
        min-height: 280px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      /* ç‰¹æ®Šçš„è† å¸¶æ¨£å¼ */
      .hero-note .tape {
        background-color: rgba(255, 112, 67, 0.5); /* æ©˜è‰²è† å¸¶ */
        width: 120px;
        top: -12px;
        transform: translateX(-50%) rotate(2deg);
      }

      .note-title {
        font-family: "Caveat", cursive;
        font-size: 1.8rem;
        color: var(--ink-secondary);
        margin-bottom: 10px;
      }

      .main-weather-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 10px 0;
      }

      .main-icon {
        font-size: 6rem;
        /* åƒè²¼ç´™ä¸€æ¨£çš„ç™½é‚Šæ•ˆæœ */
        filter: drop-shadow(0 4px 2px rgba(0, 0, 0, 0.1)) contrast(1.1);
        animation: swing 3s ease-in-out infinite;
      }

      @keyframes swing {
        0%,
        100% {
          transform: rotate(-5deg);
        }
        50% {
          transform: rotate(5deg);
        }
      }

      .main-temp {
        font-size: 4.5rem;
        font-weight: 700;
        font-family: "Caveat", cursive;
        line-height: 1;
      }

      .note-insight {
        font-size: 1.3rem;
        font-weight: 700;
        margin-top: 15px;
        padding: 10px;
        border-top: 2px dashed rgba(0, 0, 0, 0.1); /* è™›ç·šåˆ†éš” */
        width: 100%;
      }

      /* === ä¸‹æ–¹é å ±ï¼šæ‹ç«‹å¾—/å°ä¾¿æ¢ç‰† === */
      .board-title {
        font-size: 1.4rem;
        margin-left: 10px;
        margin-bottom: 20px;
        transform: rotate(-1deg);
        display: inline-block;
        background: white;
        padding: 2px 10px;
        box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
      }

      .scroll-deck {
        display: flex;
        overflow-x: auto;
        gap: 20px;
        padding: 10px 10px 30px 10px;
        scrollbar-width: none;
      }
      .scroll-deck::-webkit-scrollbar {
        display: none;
      }

      .mini-note {
        min-width: 140px;
        background-color: var(--paper-white); /* é è¨­ç™½ç´™ */
        padding: 15px;
        text-align: center;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        /* ä¸åŒçš„ä¸è¦å‰‡å½¢ç‹€ */
        border-radius: 2px 255px 3px 25px / 255px 5px 225px 5px;
        box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.1);
      }

      /* è®“å¶æ•¸çš„å¡ç‰‡å¾€åæ–¹å‘æ­ªä¸€é»ï¼Œè£½é€ å‡Œäº‚æ„Ÿ */
      .mini-note:nth-child(odd) {
        transform: rotate(-2deg);
      }
      .mini-note:nth-child(even) {
        transform: rotate(1.5deg);
        margin-top: 10px;
      }

      /* ä¸åŒé¡è‰²çš„è† å¸¶ */
      .mini-note .tape {
        width: 50px;
        height: 20px;
        top: -8px;
        background: rgba(100, 221, 23, 0.4); /* ç¶ è‰² */
      }
      .mini-note:nth-child(even) .tape {
        background: rgba(41, 182, 246, 0.4); /* è—è‰² */
      }

      .mini-time {
        font-family: "Caveat", cursive;
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--ink-secondary);
      }

      .mini-icon {
        font-size: 3rem;
        margin: 10px 0;
      }
      .mini-temp {
        font-size: 1.3rem;
        font-weight: 700;
      }

      /* æ‰‹ç¹ªé¢¨æ ¼é€²åº¦æ¢ */
      .sketch-bar-box {
        margin-top: 10px;
        width: 100%;
        height: 8px;
        border: 2px solid var(--ink-primary); /* é»‘æ¡† */
        border-radius: 10px;
        padding: 1px;
        background: white;
      }
      .sketch-bar-fill {
        height: 100%;
        background: var(--ink-accent);
        border-radius: 5px;
        /* åƒæ˜¯ç”¨å½©è‰²ç­†å¡—æ»¿çš„ç´‹ç† */
        background-image: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 2px,
          rgba(255, 255, 255, 0.5) 2px,
          rgba(255, 255, 255, 0.5) 4px
        );
      }

      /* Loading Animation */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--wall-bg);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 999;
        transition: opacity 0.5s;
      }
      .loading-note {
        background: var(--paper-white);
        padding: 40px;
        transform: rotate(-3deg);
        box-shadow: 5px 10px 20px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
    </style>
  </head>

  <body>
    <div id="loading" class="loading-overlay">
      <div class="loading-note paper-note">
        <div class="tape"></div>
        <div style="font-size: 4rem">âœï¸</div>
        <p style="font-family: 'Caveat'; font-size: 1.5rem; margin-top: 10px">
          æ­£åœ¨å¯«ä¸‹ä»Šå¤©çš„å¤©æ°£...
        </p>
      </div>
    </div>

    <div class="status-bar">
      <div class="location-tag" id="locationTag">ğŸ“ TW</div>
      <div class="date-stamp" id="dateStamp">Dec 01</div>
    </div>

    <div class="container" id="mainContent" style="display: none">
      <div id="heroContainer"></div>

      <h3 class="board-title">Future Notes</h3>
      <div class="scroll-deck" id="forecastDeck"></div>
    </div>

    <script>
      const API_URL = "https://tyweather.zeabur.app/api/weather/kaohsiung";

      // éš¨æ©Ÿåˆ†é…ä¾¿æ¢ç´™é¡è‰²
      const PAPER_COLORS = [
        "var(--paper-white)",
        "var(--paper-blue)",
        "var(--paper-green)",
        "var(--paper-pink)",
        "var(--paper-purple)",
      ];

      function getRandomColor(index) {
        return PAPER_COLORS[index % PAPER_COLORS.length];
      }

      function getWeatherIcon(weather) {
        if (!weather) return "ğŸŒ¤ï¸";
        if (weather.includes("é›·")) return "â›ˆï¸";
        if (weather.includes("é›¨")) return "ğŸŒ§ï¸";
        if (weather.includes("å¤šé›²") && weather.includes("æ™´")) return "â›…";
        if (weather.includes("å¤šé›²")) return "â˜ï¸";
        if (weather.includes("é™°")) return "â˜ï¸";
        if (weather.includes("æ™´")) return "â˜€ï¸";
        return "ğŸŒ¤ï¸";
      }

      function generateInsight(weather, rainProb, maxTemp) {
        let text = "";
        const rain = parseInt(rainProb);
        const temp = parseInt(maxTemp);

        if (rain > 60) text = "å¤–é¢æ¿•ç­”ç­”ï¼Œè¨˜å¾—å¸¶å‚˜å–”ï¼â˜”";
        else if (temp >= 30) text = "è¶…ç´šç†±ï¼å»å–æ¯æ¶¼çš„å§ ğŸ¹";
        else if (temp <= 18) text = "æœ‰é»å†·ï¼Œåœå·¾æ˜¯å¥½å¤¥ä¼´ ğŸ§£";
        else if (rain > 30) text = "å¸¶æŠŠå‚˜æ¯”è¼ƒå®‰å¿ƒ ğŸŒ‚";
        else if (weather.includes("æ™´")) text = "é™½å…‰çœŸå¥½ï¼Œå»æ•£æ•£æ­¥å§ï¼âœ¨";
        else text = "èˆ’èˆ’æœæœçš„æ—¥å­ â˜ï¸";
        return text;
      }

      function getTimePeriodName(startTime) {
        const date = new Date(startTime);
        const hour = date.getHours();
        if (hour >= 0 && hour < 6) return "Midnight";
        if (hour >= 6 && hour < 11) return "Morning";
        if (hour >= 11 && hour < 14) return "Noon";
        if (hour >= 14 && hour < 18) return "Afternoon";
        if (hour >= 18 && hour < 22) return "Evening";
        return "Night";
      }

      function renderWeather(data) {
        const forecasts = data.forecasts;
        const current = forecasts[0];

        // 1. æ›´æ–°é ‚éƒ¨è³‡è¨Š
        if (data.city)
          document.getElementById("locationTag").innerText = data.city;
        const now = new Date();
        document.getElementById("dateStamp").innerText = `${
          now.getMonth() + 1
        }/${now.getDate()}`;

        // 2. æ¸²æŸ“ä¸»ä¾¿æ¢ (Hero Note)
        const avgTemp = Math.round(
          (parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2
        );
        const insight = generateInsight(
          current.weather,
          current.rain,
          current.maxTemp
        );
        const timeName = getTimePeriodName(current.startTime);

        document.getElementById("heroContainer").innerHTML = `
            <div class="paper-note hero-note">
                <div class="tape"></div>
                <div class="note-title">Now / ${timeName}</div>
                
                <div class="main-weather-row">
                    <div class="main-icon">${getWeatherIcon(
                      current.weather
                    )}</div>
                    <div class="main-temp">${avgTemp}Â°</div>
                </div>

                <div class="note-insight">
                    ${insight}
                </div>
                <div style="margin-top:10px; font-size:0.9rem; color:var(--ink-secondary)">
                    æ¿•åº¦: ${current.rain}% / ${current.comfort}
                </div>
            </div>
        `;

        // 3. æ¸²æŸ“å°ä¾¿æ¢ç‰† (Forecast Deck)
        const deck = document.getElementById("forecastDeck");
        deck.innerHTML = "";

        // è·³éç¬¬ä¸€å€‹(ç¾åœ¨)ï¼Œé¡¯ç¤ºå¾Œé¢5å€‹
        forecasts.slice(1, 6).forEach((f, index) => {
          let timeLabel = getTimePeriodName(f.startTime);
          const fDate = new Date(f.startTime);
          const today = new Date().getDate();

          if (fDate.getDate() !== today) timeLabel = "Tomorrow";

          const rainProb = parseInt(f.rain) || 0;
          const bgStyle = `background-color: ${getRandomColor(index + 1)}`; // +1 é¿å…è·Ÿä¸»è‰²é‡è¤‡

          deck.innerHTML += `
            <div class="paper-note mini-note" style="${bgStyle}">
                <div class="tape"></div>
                <div class="mini-time">${timeLabel}</div>
                <div class="mini-icon">${getWeatherIcon(f.weather)}</div>
                <div class="mini-temp">${f.minTemp}Â°-${f.maxTemp}Â°</div>
                
                <div style="font-size:0.8rem; margin-top:5px; color:var(--ink-secondary)">Rain ${rainProb}%</div>
                <div class="sketch-bar-box">
                    <div class="sketch-bar-fill" style="width: ${rainProb}%"></div>
                </div>
            </div>
          `;
        });
      }

      async function fetchWeather() {
        try {
          const delayPromise = new Promise((resolve) =>
            setTimeout(resolve, 1000)
          );
          const fetchPromise = fetch(API_URL).then((res) => res.json());

          const [_, json] = await Promise.all([delayPromise, fetchPromise]);

          if (json.success) {
            renderWeather(json.data);
            const loading = document.getElementById("loading");
            loading.style.opacity = 0;
            setTimeout(() => {
              loading.style.display = "none";
              document.getElementById("mainContent").style.display = "block";
            }, 500);
          }
        } catch (e) {
          console.error(e);
          document.getElementById(
            "heroContainer"
          ).innerHTML = `<div class="paper-note">ç„¡æ³•è®€å–ä¾¿æ¢...</div>`;
          document.getElementById("loading").style.display = "none";
          document.getElementById("mainContent").style.display = "block";
        }
      }

      document.addEventListener("DOMContentLoaded", fetchWeather);
    </script>
  </body>
</html>
